// Generated by CoffeeScript 1.8.0
define(['utils', 'ehbs!templates/edit'], function(u) {
  var EditRoute;
  return EditRoute = {
    bind: function(App) {
      App.EditRoute = Ember.Route.extend({
        model: function() {
          return new Ember.RSVP.Promise(function(resolve, reject) {
            return new Ember.RSVP.hash({
              bots: Ember.$.getJSON('/bot/bots')
            }).then(function(result) {
              return resolve({
                bots: result.bots
              });
            }, function(errors) {
              return reject(errors);
            });
          });
        },
        afterModel: function(model) {
          if (model.bots.length > 0) {
            this.controllerFor('edit').set('bot', null);
            return this.controllerFor('edit').set('bot', model.bots[0]);
          }
        }
      });
      return App.EditController = Ember.ObjectController.extend({
        bot: null,
        grammar: null,
        aiml: null,
        grammars: [],
        aimls: [],
        botChanged: (function() {
          var thiz;
          if (this.get('bot') == null) {
            return false;
          }
          thiz = this;
          Ember.$.getJSON('/bot/grammars?bot=' + this.get('bot')).then(function(result) {
            var a, key, keys, value, _i, _len;
            a = [];
            keys = u.keys(result);
            for (_i = 0, _len = keys.length; _i < _len; _i++) {
              key = keys[_i];
              value = result[key];
              a.push({
                name: key,
                path: value
              });
            }
            thiz.set('grammars', a);
            if (a.length > 0) {
              return thiz.set('grammar', a[0]);
            }
          }, function(errors) {
            return thiz.set('grammars', []);
          });
          return Ember.$.getJSON('/bot/aimls?bot=' + this.get('bot')).then(function(result) {
            var b, key, keys, value, _i, _len;
            b = [];
            keys = u.keys(result);
            for (_i = 0, _len = keys.length; _i < _len; _i++) {
              key = keys[_i];
              value = result[key];
              b.push({
                name: key,
                path: value
              });
            }
            thiz.set('aimls', b);
            if (b.length > 0) {
              return thiz.set('aiml', b[0]);
            }
          }, function(errors) {
            return thiz.set('aimls', []);
          });
        }).observes('bot'),
        grammarChanged: (function() {
          var path, thiz;
          thiz = this;
          path = this.get('grammar.path');
          if (path == null) {
            return;
          }
          return Ember.$.getJSON('/edit/file?encoding=GB18030&path=' + path).then(function(result) {
            return thiz.set('fileGrammar', result);
          }, function(errors) {
            return thiz.set('fileGrammar', errors.responseText);
          });
        }).observes('grammar'),
        aimlChanged: (function() {
          var path, thiz;
          thiz = this;
          path = this.get('aiml.path');
          if (path == null) {
            return;
          }
          return Ember.$.getJSON('/edit/file?encoding=UTF-8&path=' + path).then(function(result) {
            return thiz.set('fileAIML', result);
          }, function(errors) {
            return thiz.set('fileAIML', errors.responseText);
          });
        }).observes('aiml'),
        actions: {
          saveGrammar: function(grammar, file) {
            $.ajax({
              url: '/edit/upload',
              type: 'POST',
              data: JSON.stringify({
                path: grammar.path,
                encoding: 'GB18030',
                text: file
              }),
              contentType: 'application/json; charset=gb18030'
            }).done(function(result) {
              alert('Grammar saved to server successfully!');
              return true;
            }).fail(function(response) {
              alert(response.responseText);
              return false;
            });
            return false;
          },
          saveAIML: function(aiml, file) {
            $.ajax({
              url: '/edit/upload',
              type: 'POST',
              data: JSON.stringify({
                path: aiml.path,
                encoding: 'UTF-8',
                text: file
              }),
              contentType: 'application/json; charset=utf-8'
            }).done(function(result) {
              alert('AIML saved to server successfully!');
              return true;
            }).fail(function(response) {
              alert(response.responseText);
              return false;
            });
            return false;
          },
          compile: function(bot) {
            var thiz;
            thiz = this;
            $.ajax({
              url: '/bot/compile',
              type: 'POST',
              data: JSON.stringify({
                bot: bot
              }),
              contentType: 'application/json; charset=utf-8'
            }).done(function(result) {
              return alert('Grammar compilation done for bot ' + bot);
            }).fail(function(response) {
              return alert('Grammar compilation failed for bot ' + bot + ' ' + response.responseText);
            });
            return false;
          },
          reload: function(bot) {
            var thiz;
            thiz = this;
            $.ajax({
              url: '/bot/reload',
              type: 'POST',
              data: JSON.stringify({
                bot: bot
              }),
              contentType: 'application/json; charset=utf-8'
            }).done(function(result) {
              alert('Bot reloaded successfully for ' + bot);
              return true;
            }).fail(function(response) {
              alert('Bot reloading failed for bot ' + bot + ' ' + response.responseText);
              return false;
            });
            return false;
          },
          addGrammar: function(bot) {
            var grammar, grammars, name, thiz, _i, _len;
            thiz = this;
            name = prompt('Grammar File Name (No Extension)', 'filename');
            if (name == null) {
              return false;
            }
            grammars = this.get('grammars');
            for (_i = 0, _len = grammars.length; _i < _len; _i++) {
              grammar = grammars[_i];
              if (grammar.name.toLowerCase() === (name + '.gram').toLowerCase()) {
                return alert('Duplicated filename is not allowed');
              }
            }
            $.ajax({
              url: '/edit/create',
              type: 'POST',
              data: JSON.stringify({
                bot: bot,
                type: 'grammar',
                name: name,
                text: ''
              }),
              contentType: 'application/json; charset=utf-8'
            }).done(function(result) {
              var fresh;
              grammars = thiz.get('grammars');
              fresh = {
                name: name + '.gram',
                path: result
              };
              grammars.pushObject(fresh);
              thiz.set('grammars', grammars);
              thiz.set('grammar', fresh);
              return true;
            }).fail(function(response) {
              alert('Adding new grammar file failed ' + response.responseText);
              return false;
            });
            return false;
          },
          addAIML: function(bot) {
            var aiml, aimls, name, thiz, _i, _len;
            thiz = this;
            name = prompt('AIML File Name (No Extension)', 'filename');
            if (name == null) {
              return false;
            }
            aimls = this.get('aimls');
            for (_i = 0, _len = aimls.length; _i < _len; _i++) {
              aiml = aimls[_i];
              if (aiml.name.toLowerCase() === (name + '.gram').toLowerCase()) {
                return alert('Duplicated filename is not allowed');
              }
            }
            $.ajax({
              url: '/edit/create',
              type: 'POST',
              data: JSON.stringify({
                bot: bot,
                type: 'aiml',
                name: name,
                text: ''
              }),
              contentType: 'application/json; charset=utf-8'
            }).done(function(result) {
              var fresh;
              aimls = thiz.get('aimls');
              fresh = {
                name: name + '.aiml',
                path: result
              };
              aimls.pushObject(fresh);
              thiz.set('aimls', aimls);
              thiz.set('aiml', fresh);
              return true;
            }).fail(function(response) {
              alert('Adding new aiml file failed ' + response.responseText);
              return false;
            });
            return false;
          },
          deleteGrammar: function(grammar) {
            var answer, path, thiz;
            answer = confirm('Do you want to delete grammar file ' + grammar.name + '?');
            if (!answer) {
              return false;
            }
            thiz = this;
            path = grammar.path;
            $.ajax({
              url: '/edit/remove?path=' + path,
              type: 'DELETE'
            }).done(function(result) {
              var grammars;
              grammars = thiz.get('grammars');
              grammars.removeObject(grammar);
              if (grammars.length > 0) {
                thiz.set('grammar', grammars[0]);
              }
              return true;
            }).fail(function(response) {
              alert('Deleting grammar failed ' + response.responseText);
              return false;
            });
            return false;
          },
          deleteAIML: function(aiml) {
            var answer, path, thiz;
            answer = confirm('Do you want to delete aiml file ' + aiml.name + '?');
            if (!answer) {
              return false;
            }
            thiz = this;
            path = aiml.path;
            $.ajax({
              url: '/edit/remove?path=' + path,
              type: 'DELETE'
            }).done(function(result) {
              var aimls;
              aimls = thiz.get('aimls');
              aimls.removeObject(aiml);
              if (aimls.length > 0) {
                thiz.set('aiml', aimls[0]);
              }
              return true;
            }).fail(function(response) {
              alert('Deleting aiml failed ' + response.responseText);
              return false;
            });
            return false;
          }
        }
      });
    }
  };
});
